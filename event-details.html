<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Event Details - Tixbro</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&family=Poppins:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        .event-hero {
            height: 400px;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        .event-hero-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.7));
        }
        .event-info {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-top: -100px;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .price-box {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            position: sticky;
            top: 100px;
        }
        .ticket-quantity {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
        }
        .quantity-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            font-size: 20px;
            cursor: pointer;
        }
        .quantity-btn:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="container-fluid nav-bar p-0">
        <nav class="navbar navbar-expand-lg navbar-light bg-white px-4 px-lg-5 py-3 py-lg-0">
            <a href="index.html" class="navbar-brand p-0">
                <h1 class="display-5 text-secondary m-0">Tixbro</h1>
            </a>
            <div class="navbar-nav ms-auto">
                <a href="shop.html" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Shop
                </a>
            </div>
        </nav>
    </div>

    <!-- Event Hero -->
    <div id="eventHero" class="event-hero">
        <div class="event-hero-overlay"></div>
    </div>

    <!-- Event Details -->
    <div class="container">
        <div class="event-info">
            <div class="row">
                <!-- Left Column - Details -->
                <div class="col-lg-8">
                    <span id="eventCategory" class="badge bg-primary mb-3"></span>
                    <h1 id="eventTitle" class="display-4 mb-4"></h1>

                    <div class="mb-4">
                        <h5><i class="fas fa-info-circle text-primary me-2"></i>Description</h5>
                        <p id="eventDescription" class="text-muted"></p>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <h6><i class="fas fa-calendar text-primary me-2"></i>Date & Time</h6>
                            <p id="eventDateTime" class="mb-0"></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6><i class="fas fa-map-marker-alt text-primary me-2"></i>Location</h6>
                            <p id="eventLocation" class="mb-0"></p>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h6><i class="fas fa-building text-primary me-2"></i>Venue</h6>
                        <p id="eventVenue" class="mb-0"></p>
                    </div>
                </div>

                <!-- Right Column - Booking -->
                <div class="col-lg-4">
                    <div class="price-box">
                        <h3 class="text-center mb-3">Book Tickets</h3>
                        <div class="text-center mb-3">
                            <h2 id="eventPrice" class="text-primary"></h2>
                            <small class="text-muted">per ticket</small>
                        </div>

                        <div class="ticket-quantity">
                            <button class="quantity-btn" onclick="changeQuantity(-1)">-</button>
                            <input type="number" id="ticketQuantity" value="1" min="1" class="form-control text-center" style="width: 80px;" readonly>
                            <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
                        </div>

                        <div class="alert alert-info" id="availableTickets"></div>

                        <div class="mb-3">
                            <h5>Total: <span id="totalPrice" class="text-primary">₹0</span></h5>
                        </div>

                        <button id="buyButton" class="btn btn-primary w-100 btn-lg" onclick="buyTickets()">
                            <i class="fas fa-ticket-alt me-2"></i>Buy Tickets
                        </button>

                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                <i class="fas fa-lock me-1"></i>Secure payment via Stripe
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div style="height: 100px;"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { getEvent } from './js/events.js';
        import { createCheckoutSession } from './js/payment.js';

        let currentEvent = null;
        let quantity = 1;

        // Load event details on page load
        window.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('id');

            if (!eventId) {
                window.location.href = 'shop.html';
                return;
            }

            await loadEventDetails(eventId);
        });

        async function loadEventDetails(eventId) {
            try {
                const result = await getEvent(eventId);

                if (!result.success) {
                    throw new Error('Event not found');
                }

                currentEvent = result.event;
                displayEventDetails(currentEvent);

            } catch (error) {
                console.error('Error loading event:', error);
                alert('Failed to load event details');
                window.location.href = 'shop.html';
            }
        }

        function displayEventDetails(event) {
            // Set hero background
            document.getElementById('eventHero').style.backgroundImage =
                `url('${event.imageUrl || 'img/carousel-1.jpg'}')`;

            // Set details
            document.getElementById('eventCategory').textContent = getCategoryName(event.category);
            document.getElementById('eventTitle').textContent = event.title;
            document.getElementById('eventDescription').textContent = event.description;
            document.getElementById('eventDateTime').textContent =
                `${formatDate(event.date)} at ${event.time}`;
            document.getElementById('eventLocation').textContent =
                `${event.location}, ${event.city}`;
            document.getElementById('eventVenue').textContent = event.venue;
            document.getElementById('eventPrice').textContent = `₹${event.price}`;
            document.getElementById('availableTickets').textContent =
                `${event.availableTickets} tickets available`;

            // Set max quantity
            document.getElementById('ticketQuantity').max = event.availableTickets;

            // Update total price
            updateTotalPrice();

            // Disable buy button if sold out
            if (event.availableTickets === 0) {
                document.getElementById('buyButton').disabled = true;
                document.getElementById('buyButton').innerHTML =
                    '<i class="fas fa-times me-2"></i>Sold Out';
            }
        }

        // Change quantity
        window.changeQuantity = function(change) {
            const input = document.getElementById('ticketQuantity');
            const newQuantity = parseInt(input.value) + change;
            const maxTickets = currentEvent.availableTickets;

            if (newQuantity >= 1 && newQuantity <= maxTickets) {
                quantity = newQuantity;
                input.value = quantity;
                updateTotalPrice();
            }
        };

        // Update total price
        function updateTotalPrice() {
            const total = currentEvent.price * quantity;
            document.getElementById('totalPrice').textContent = `₹${total}`;
        }

        // Buy tickets
        window.buyTickets = async function() {
            if (!currentEvent || currentEvent.availableTickets === 0) {
                alert('No tickets available');
                return;
            }

            // Disable button
            const button = document.getElementById('buyButton');
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

            try {
                const result = await createCheckoutSession(currentEvent.eventId, quantity);

                if (!result.success) {
                    throw new Error(result.error);
                }

                // Redirect happens automatically in createCheckoutSession

            } catch (error) {
                console.error('Checkout error:', error);
                alert('Failed to initiate checkout: ' + error.message);
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-ticket-alt me-2"></i>Buy Tickets';
            }
        };

        // Helper functions
        function getCategoryName(category) {
            const categories = {
                'movies': 'Movies',
                'concerts': 'Concerts',
                'sports': 'Sports Events',
                'theatre': 'Theatre & Plays',
                'turf': 'Turf Booking',
                'college-fest': 'College Fests',
                'bus': 'Bus Tickets',
                'events': 'Events & More'
            };
            return categories[category] || category;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }
    </script>
</body>
</html>
